# 楚留香音乐盒::使用帮助

欢迎使用同类软件中历史最悠久, 功能最先进, 效果最好并且完全开源免费的手机端自动演奏神器: 楚留香音乐盒  

## 1. 下载安装

事实上如果你是从脚本中"使用说明"点击进入本页面, 那么你已经安装好了。
否则请参考[https://github.com/happyme531/clxTools/blob/master/README.md](https://github.com/happyme531/clxTools/blob/master/README.md)中的说明。

## 2. 导入音乐文件

将音乐文件放入手机内部存储中的`楚留香音乐盒`目录下即可, 运行脚本就可以看到导入的文件。如果你看不到这个目录, 请先运行一次脚本, 之后再查看。  

目前支持的文件类型:  

1. MIDI:  
    这是世界上最为通用的音乐文件格式之一。
    文件后缀名为.mid。
    网上到处都能找到各种midi音乐, 你可以自行搜索下载想要的音乐。  
    我推荐的下载网站是: https://www.midishow.com/ 。注意: 下载需要积分, 但评论就可以获得等量的积分, 先试听评论后再下载即可。  
    - 如果你想要的音乐找不到midi格式但可以在b站找到原神弹琴视频, 这时使用 https://github.com/happyme531/GenshinImpactPianoExtract 可以将一段原神弹琴视频转换为脚本可用的MIDI文件。(效果不错)
    - 可以使用WIDI/piano-transcription/basicpitch等软件将mp3转换为midi。(效果不一定好)

2. DoMiSo:  
    这是Nigh@github.com开发的一种音乐文件格式。
    这些音乐文件的原后缀名为.txt, 为了脚本正常识别, 你需要将后缀名改为.dms.txt。
    参见: https://github.com/Nigh/DoMiSo-genshin  
 
3. 光遇 SkyStudio:  
    为光遇演奏设计的一种音乐文件格式。
    这些音乐文件的原后缀名为.txt, 为了脚本正常识别, 你需要将后缀名改为.skystudio.txt。
    - 在各种地方都能找到SkyStudio乐谱, 你可以自行搜索下载想要的音乐。
    - 可以下载[SkyStudio](https://play.google.com/store/apps/details?id=com.Maple.SkyStudio)进行编曲。
    - 在 https://github.com/StageGuard/SkyAutoPlayerScript 可以找到一些乐谱。  
    注意: 这个格式中音符的范围只有C4-C6, 总计15个.

### 歌词显示

脚本会自动加载音乐文件夹下与音乐文件同名的.lrc文件, 在开始播放时显示歌词。点击歌词区域可以查看全部歌词, 点击某行歌词可以跳转到对应时间。

## 3. 游戏选择

使用前请在 主菜单 -> 全局设置 -> 选择游戏/乐器 菜单中选择与你的游戏对应的选项。
如果没有对应的乐器, 选择"默认"即可。  

- 逆水寒手游 专业模式: 使用时请把按键范围调整到最大, 否则点击位置会不正确.  
- 逆水寒手游 曲笛: 需要打开 和弦优化 且把 最多同时按键数量 调整为1, 否则会严重漏音.

## 4. 配置说明

- 运行模式
  - 自动弹奏: 自动弹奏乐曲.
  - 跟弹模式(简易): 在屏幕上对应位置显示按键提示, 你可以跟着提示演奏.
  - 跟弹模式(类光遇): 类似光遇的高级跟弹模式，会以光圈形式提示按下的按键与按键时间，并使用连线与动画提示旋律变化，动画流畅，效果更好。
- 乐谱可视化
  - 使用乐谱可视化: 在屏幕上以图形化方式显示之后一段时间的按键位置列表，方便观察乐曲的结构。目前只对网格排列的键位有效。

### 跟弹模式配置

- 图案大小:
  调整跟弹模式中按键提示的大小.  
- 为每一个音符画出引导线:
  类光遇跟弹模式中默认只会在当前最高音符所在按键与下一组中最高按键之间画出引导线. 打开这个选项后, 会和下一组每个按键之间都画出引导线.  
  + 如果你想练习多指和弦, 打开它可以更好地看到其它按键的位置.
  + 如果你只打算使用单指, 关闭它可以减少视觉干扰.
- 为下下一个音符画出引导线:
  打开这个选项后, 下一组中最高音符与下下一组中最高音符之间也会画出浅色引导线.   
  + 打开可以更好地展示旋律的变化.
  + 关闭可以简化视觉效果.
- 振动效果:
  在需要按键时给出振动反馈, 帮助你更好地掌握节奏. 可以选择关闭/弱/中/强四种振动强度.

### 速度控制

- 变速:  
  调整播放速度, 使乐曲整体变快或变慢.  
- 限制点击速度:  
  通过限制最快的点击速度使乐曲较快的部分变慢, 而较慢的部分不变. 会在变速后应用.  

### 时长控制(输出)

- 时长输出模式:
  - 固定值: 对于所有音符, 点击屏幕的时长都为固定值(默认点击时长). 适用于不管按住按键多久, 发出声音长短都一样的乐器(绝大多数游戏都是这样).
  - 真实时长(实验性): 点击屏幕的时长为每个音符的真实时长. 适用于光遇的小提琴, 萨克斯和逆水寒的曲笛等按住会持续发声的乐器. 注意: 只对MIDI和Tone.js JSON格式有效(因为其他格式的文件中没有真实时长信息). 目前处于实验性阶段, 可能会有游戏崩溃, 系统卡死等问题.
- 默认点击时长:  
  在固定值模式下控制每次点击屏幕的时长. 建议尽量小, 除非点击太快游戏不识别. 一般情况下不需要调整.
- 最长手势持续时间:
  真实时长模式下每一组手势的最长持续时间. 太大的值可能会造成悬浮窗操作卡顿, 太小的值可能会造成长音被截断, 但总体上影响不会很大.
  + 如果点击播放暂停按钮后音乐过了很久才停止, 可以降低这个值.
  + 如果乐曲中的长音明显变短了, 可以增大这个值.
- 按键间留空时间:
  真实时长模式下抬起-按下两次按键之间的间隔时间. 过小和过大都可能会造成漏音, 但默认值一般不需要调整. 在按键间插入间隔是对目前不成熟的算法的一种补救措施, 以后可能会被移除.
  + 如果短音符被漏掉, 可以增大这个值.
  + 如果很多音符都被明显缩短, 可以减小这个值.
- 邻近音符最大间隔:
  如果两个音符之间的间隔低于这个值, 则认为它们应该同时按下.
  + 如果应该被同时按下的音符被错误的分开了, 可以增大这个值. 建议在导出键盘谱时增大.
  + 如果紧挨着但不应该同时按下的音符被同时按下了, 可以减小这个值.

### 音域优化

- 半音处理方法:  
  乐曲中一个八度有12个音, 但大多游戏只有7个音(没有黑键). 对于没有对应音的音符, 可以选择向下取整(弹奏比这个音符低一点的音)/向上取整(弹奏比这个音符高一点的音)/丢弃半音(不弹奏)/同时上下取整(同时弹奏高低音). 一般情况下不需要调整.
- 自动调整禁用音轨阈值:  
  对于有多个音轨的乐曲, 有些音轨可能音高很高/很低, 其中的一部分音符超出了游戏可以演奏的范围. 自动调整可以将这些音轨禁用, 优化演奏的效果. 这个值越高保留的音轨越多, 值越低禁用的音轨越多.
- 升/降八度, 升/降半音:  
  调整乐曲的音高, 使其适应游戏的音域. 这两个选项会在第一次演奏时自动设定, 一般不需要手动调整. 如果发现自动调整后仍然有些音符超出范围导致演奏效果不好, 可以手动调节升/降八度设置.
- 移动高八度音符到音域内:
  如果音符超出了游戏的音域, 将高于音域八度内的音符移动到音域内. 也许能提高演奏效果? 如果听起来感觉不对, 可以关闭这个选项.
- 移动低八度音符到音域内:
  同上, 但是是将低于音域八度内的音符移动到音域内.
- 音轨选择:  
  有些MIDI文件中有多个音轨, 音轨的内容可能为主旋律, 伴奏, 和弦等, 可以在这里选择要演奏的音轨, 默认为所有音轨.  

### 和弦优化

- 最多同时按键数量:
  限制每次点击屏幕时最多同时按下的按键数量. 有些游戏中同时点击的按键太多会造成漏音或者声音异常, 可以调节此设置优化. 练习时如果按键太多手忙脚乱, 也可以调低这个值.
- 按键数量限制方法:
  - 删除超出的: 如果同时按下的按键数量超过了限制, 则删除超出的按键.
  - 拆分成多组: 如果同时按下的按键数量超过了限制, 则将按键分成多组, 每组不超过限制数量, 且之间有一定的间隔.
- 拆分成多组时组间间隔:
  拆分成多组时, 每组之间的间隔时间.  
- 选择方式:
  - 优先高音: 优先选择高音, 适合演奏主旋律.
  - 优先低音: 优先选择低音.
  - 随机: 随机选择. 一般和"拆分成多组"一起使用.

### 伪装手弹(全局)

(这些设置是全局设置, 意味着所有乐曲都会使用这些设定值)

- 音符时间偏差:  
  为每个音符的开始时间添加一个随机的偏差, 让演奏效果更接近人手弹奏的感觉. (但实际使用中似乎更接近网络延迟的感觉?)  
- 点击位置偏差:  
  给每次点击屏幕的位置添加一个随机的偏差, 或许能起到防止被游戏识别为脚本操作的作用. 设为0为关闭, 太高的值会导致偶尔按错键.  

### 跳过空白

- 跳过前奏空白:  
  在播放时跳过前奏的空白部分, 直接开始演奏. 
- 跳过中间空白:
  在播放时省略乐曲中间超过5秒的空白部分.
  
## 一些提示

- 点击悬浮窗的时间显示区域可以移动/缩放悬浮窗, 双击恢复默认位置和大小

## 附加功能: MIDI串流演奏

  使用此功能可以实时演奏电脑上的MIDI文件，或者连接电子琴/MIDI键盘等设备直接在游戏中演奏。

  1. 将手机的**USB配置**设置为**MIDI**. 有些手机可以在连接USB后直接选择, 有些手机需要在**开发者选项**中设置.
  2. 连接手机到电脑, 此时电脑上会识别到MIDI设备.  
  3. 打开脚本的**MIDI串流**功能, 在电脑上选择MIDI输出设备为手机, 即可进行MIDI串流演奏.
  4. MIDI串流时可以在设置界面调整升降八度，移调与连续点击模拟长音等设置。
   
## 蓝牙MIDI演奏
 
  由于Auto.js没有控制蓝牙的权限, 所以无法直接使用蓝牙MIDI, 需要安装一个小插件来实现.

  1. 安装插件: 在手机内部存储中的`楚留香音乐盒`目录(即音乐文件目录)或脚本文件夹的`exampleTracks`目录中有一个名为`midibtlepairing.apk`的文件, 安装即可.
  2. 连接蓝牙设备: 打开插件, 扫描并连接蓝牙MIDI设备.
  3. 打开脚本的**MIDI串流**功能, 即可识别到蓝牙MIDI设备并进行MIDI演奏. (不需要更改USB配置)
  